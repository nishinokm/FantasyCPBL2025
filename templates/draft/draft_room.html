{% extends "layouts/base.html" %}
{% load static %}
{% block extrastyle %}
<style>
  .draft-table td, .draft-table th {
    width: 120px;
    word-break: break-word;
    white-space: normal;
    text-align: center;
    vertical-align: middle;
  }
</style>
{% endblock extrastyle %}


{% block content %}
<div class="container-fluid py-4">
  <div class="row">
    <!-- Draft Main Panel -->
    <div class="col-lg-8">
      <div id="current-status" class="mb-3 fs-5 fw-bold text-primary">目前輪次：-，順位：-</div>

      <!-- 已選名單 -->
      <div class="card mb-3">
        <div class="card-header bg-primary text-white">已選球員</div>
        <div class="card-body p-0">
          <table class="table table-bordered mb-0 draft-table">
            <thead>
              <tr id="draft-header-row">
                <th>輪次 \\ 順位</th>
                <!-- JS 會填入順位 -->
              </tr>
            </thead>
            <tbody id="draft-progress-body"></tbody>
          </table>
        </div>
      </div>

      <!-- 預排清單 -->
      <div class="card mb-3">
        <div class="card-header bg-success text-white">預排清單</div>
        <div class="card-body">
          <ul class="list-group" id="pre-draft-queue"></ul>
          <div id="pick-action" class="mt-3 d-none">
            <button class="btn btn-success" id="submit-pick-btn">送出本輪預排選手</button>
          </div>
        </div>
      </div>

      <!-- 可選球員 -->
      <div class="card">
        <div class="card-header bg-secondary text-white">尚未被選的球員</div>
        <div class="card-body p-0" style="max-height: 300px; overflow-y: auto;">
          <ul class="list-group list-group-flush" id="available-player-list"></ul>
        </div>
      </div>
    </div>

    <!-- 聊天區塊 -->
    <div class="col-lg-4">
      <div class="card shadow">
        <div class="card-header bg-gradient-info text-white">
          <h6 class="mb-0">聊天室</h6>
        </div>
        <div class="card-body" id="chat-box" style="height: 400px; overflow-y: auto;"></div>
        <div class="card-footer p-2">
          <div class="input-group">
            <input type="text" id="chat-message" class="form-control" placeholder="輸入訊息...">
            <button id="send-btn" class="btn btn-info">送出</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const STATIC_TEAM_BASE = "{% static 'assets/images/teams/' %}";
  const draftId = {{ draft.id }};
  const currentUserId = {{ request.user.id }};
  let preDraftQueue = [];

  function fetchSnapshot() {
    fetch(`/draft/${draftId}/snapshot/`)
      .then(res => res.json())
      .then(data => {
        updateDraftProgress(data.units);
        updateAvailablePlayers(data.available_players);
        updateCurrentStatus(data.current_round, data.current_pick, data.is_your_turn);
      });
  }

  function updateDraftProgress(roundGroups) {
    const table = document.getElementById('draft-progress-body');
    const headerRow = document.getElementById('draft-header-row');
    table.innerHTML = '';
    headerRow.innerHTML = '<th>輪次 \\ 順位</th>';
  
    // 計算最大順位數（統一列長度）
    const maxPickCount = Math.max(...roundGroups.map(g => g.picks.length));
  
    // 產生順位標題欄
    for (let i = 1; i <= maxPickCount; i++) {
      const th = document.createElement('th');
      th.textContent = i;
      headerRow.appendChild(th);
    }
  
    // 每一輪渲染成 row
    roundGroups.forEach(group => {
      const row = document.createElement('tr');
  
      // 輪次欄位
      const roundCell = document.createElement('td');
      roundCell.textContent = `第 ${group.round} 輪`;
      row.appendChild(roundCell);
  
      // 固定補滿每輪長度
      for (let i = 0; i < maxPickCount; i++) {
        const pick = group.picks[i];
        const cell = document.createElement('td');
  
        if (pick) {
          const chunks = pick.player.match(/.{1,5}/g) || [];
          const nameWithBreak = chunks.join('<br>');
          const imgTag = pick.team_id
          ? `<img src="${STATIC_TEAM_BASE}${pick.team_id}.png" alt="${pick.team_id}" style="width: 16x; height: 16px;" class="me-1">`
          : '';
          cell.innerHTML = imgTag + nameWithBreak;
          cell.style.backgroundColor = pick.color;
          cell.classList.add('text-white', 'fw-bold', 'text-center');
        } else {
          cell.textContent = '-';
          cell.classList.add('text-muted', 'text-center');
        }
  
        row.appendChild(cell);
      }
  
      table.appendChild(row);
    });
  }

  function updateAvailablePlayers(players) {
    const list = document.getElementById('available-player-list');
    list.innerHTML = '';
    players.forEach(p => {
      const item = document.createElement('li');
      item.classList.add('list-group-item', 'd-flex', 'justify-content-between');
      item.innerHTML = `
        <span>${p.name}</span>
        <button class="btn btn-sm btn-outline-primary" onclick="addToQueue(${p.id}, '${p.name}')">預排</button>
      `;
      list.appendChild(item);
    });
  }

  function updateCurrentStatus(round, pick, isYourTurn) {
    const status = document.getElementById('current-status');
    status.innerHTML = `目前輪次：<strong>${round}</strong>，順位：<strong>${pick}</strong>`;
    const actionBlock = document.getElementById('pick-action');
    actionBlock.classList.toggle('d-none', !(isYourTurn && preDraftQueue.length > 0));
  }

  function addToQueue(id, name) {
    if (!preDraftQueue.find(p => p.id === id)) {
      preDraftQueue.push({ id, name });
      updateQueueUI();
    }
  }

  function removeFromQueue(index) {
    preDraftQueue.splice(index, 1);
    updateQueueUI();
  }

  function updateQueueUI() {
    const queueEl = document.getElementById('pre-draft-queue');
    queueEl.innerHTML = '';
    preDraftQueue.forEach((player, index) => {
      const item = document.createElement('li');
      item.classList.add('list-group-item', 'd-flex', 'justify-content-between');
      item.innerHTML = `
        <span>${player.name}</span>
        <button class="btn btn-sm btn-danger" onclick="removeFromQueue(${index})">移除</button>
      `;
      queueEl.appendChild(item);
    });
  }

  document.getElementById('submit-pick-btn').onclick = function () {
    if (preDraftQueue.length === 0) return;
    const selected = preDraftQueue.shift();
    updateQueueUI();
    fetch(window.location.origin + '/draft/draft_pick_api/', {
      method: 'POST',
      headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({ draft_id: draftId, player_id: selected.id })
    }).then(fetchSnapshot);
  };

  // 啟動輪詢
  setInterval(fetchSnapshot, 3000);
  fetchSnapshot();

  // WebSocket for chat only
  const protocol = window.location.protocol === "https:" ? "wss" : "ws";
  const socket = new WebSocket(protocol + '://' + window.location.host + '/ws/draft/{{ draft.id }}/');

  socket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    if (data.type === 'chat') {
      const chatBox = document.getElementById('chat-box');
      const message = document.createElement('div');
      message.innerHTML = `<strong>${data.user}：</strong> ${data.message}`;
      chatBox.appendChild(message);
      chatBox.scrollTop = chatBox.scrollHeight;
    }
  };
  socket.onclose = function(e) { console.error('聊天連線中斷'); };
  document.getElementById('send-btn').onclick = function() {
    const input = document.getElementById('chat-message');
    const message = input.value;
    if (message.trim()) {
      socket.send(JSON.stringify({ type: 'chat', message: message }));
      input.value = '';
    }
  };
</script>
{% endblock %}
