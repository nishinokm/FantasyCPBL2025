{% extends "layouts/base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row">
    <!-- Draft Progress Panel -->
    <div class="col-lg-8">
      <div class="card shadow">
        <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0">é¸ç§€é€²åº¦ - {{ draft.league.name }}</h5>
          <span id="current-status">ç›®å‰è¼ªæ¬¡ï¼š<strong>{{ draft.current_round }}</strong>ï¼Œé †ä½ï¼š<strong>{{ draft.current_pick }}</strong></span>
        </div>
        <div class="card-body p-0">
          <table class="table table-striped table-hover mb-0">
            <thead class="table-dark text-center">
              <tr>
                <th>è¼ªæ¬¡</th>
                <th>é †ä½</th>
                <th>åŸéšŠä¼</th>
                <th>çƒå“¡</th>
                <th>é¸æ“‡æ™‚é–“</th>
              </tr>
            </thead>
            <tbody id="draftTable">
              {% for unit in draft_units %}
                <tr id="unit-{{ unit.round }}-{{ unit.pick }}" class="text-center {% if unit.round == draft.current_round and unit.pick == draft.current_pick %}table-warning{% endif %}">
                  <td>{{ unit.round }}</td>
                  <td>{{ unit.pick }}</td>
                  <td>{{ unit.ori_owner.name }}</td>
                  <td class="player-cell">{% if unit.player %}{{ unit.player.name }}{% else %}<em class="text-muted">å°šæœªé¸æ“‡</em>{% endif %}</td>
                  <td>{% if unit.pick_at_time %}{{ unit.pick_at_time|date:"H:i:s" }}{% else %}<span class="text-muted">-</span>{% endif %}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- é æ’æç¤ºå€å¡Š -->
      <div class="alert alert-info mt-3 d-none" id="pick-alert">
        ğŸ¯ è©²ä½ é¸äº†ï¼è«‹å¾é æ’çƒå“¡ä¸­é¸æ“‡æˆ–æ‰‹å‹•æŒ‡æ´¾ï¼
        <form id="pick-form" class="mt-2">
          <select id="pick-player-select" class="form-select mb-2">
            {% for player in available_players %}
              <option value="{{ player.id }}">{{ player.name }}</option>
            {% endfor %}
          </select>
          <button type="submit" class="btn btn-success">ç¢ºå®šé¸æ“‡</button>
        </form>
      </div>
    </div>

    <!-- Chat Box -->
    <div class="col-lg-4">
      <div class="card shadow">
        <div class="card-header bg-gradient-info text-white">
          <h6 class="mb-0">èŠå¤©å®¤</h6>
        </div>
        <div class="card-body" id="chat-box" style="height: 400px; overflow-y: auto;"></div>
        <div class="card-footer p-2">
          <div class="input-group">
            <input type="text" id="chat-message" class="form-control" placeholder="è¼¸å…¥è¨Šæ¯...">
            <button id="send-btn" class="btn btn-info">é€å‡º</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const protocol = window.location.protocol === "https:" ? "wss" : "ws";
  const socket = new WebSocket(protocol + '://' + window.location.host + '/ws/draft/{{ draft.id }}/');

  socket.onmessage = function(e) {
    const data = JSON.parse(e.data);

    if (data.type === 'chat') {
      const chatBox = document.getElementById('chat-box');
      const message = document.createElement('div');
      message.innerHTML = `<strong>${data.user}ï¼š</strong> ${data.message}`;
      chatBox.appendChild(message);
      chatBox.scrollTop = chatBox.scrollHeight;
    } else if (data.type === 'pick') {
      const tableBody = document.getElementById('draftTable');
      tableBody.innerHTML = ''; // æ¸…ç©ºåŸæœ¬è¡¨æ ¼
    
      data.draft_units.forEach(unit => {
        const row = document.createElement('tr');
        row.classList.add('text-center');
        if (unit.round === data.current_round && unit.pick === data.current_pick) {
          row.classList.add('table-warning');
        }
        row.id = `unit-${unit.round}-${unit.pick}`;
        row.innerHTML = `
          <td>${unit.round}</td>
          <td>${unit.pick}</td>
          <td>${unit.ori_owner}</td>
          <td class="player-cell">${unit.player || '<em class="text-muted">å°šæœªé¸æ“‡</em>'}</td>
          <td>${unit.pick_time}</td>
        `;
        tableBody.appendChild(row);
      });
    
      const currentStatusEl = document.getElementById('current-status');
      currentStatusEl.innerHTML = `ç›®å‰è¼ªæ¬¡ï¼š<strong>${data.current_round}</strong>ï¼Œé †ä½ï¼š<strong>${data.current_pick}</strong>`;
    
      if (data.user_id === {{ request.user.id }}) {
        document.getElementById('pick-alert').classList.remove('d-none');
      } else {
        document.getElementById('pick-alert').classList.add('d-none');
      }
    }
  };
  socket.onclose = function(e) {
    console.error('èŠå¤©é€£ç·šä¸­æ–·');
  };

  document.getElementById('send-btn').onclick = function(e) {
    const input = document.getElementById('chat-message');
    const message = input.value;
    if (message.trim()) {
      socket.send(JSON.stringify({ type: 'chat', message: message }));
      input.value = '';
    }
  };

  document.getElementById('pick-form').onsubmit = function(e) {
    e.preventDefault();
    const selected = document.getElementById('pick-player-select').value;
    socket.send(JSON.stringify({ type: 'pick', player_id: selected }));
    document.getElementById('pick-alert').classList.add('d-none');
  };
  // æ¯ 10 ç§’æª¢æŸ¥é¸ç§€é€²åº¦ï¼Œè£œå¼· WebSocket ä¸­æ–·æˆ–å»¶é²
  setInterval(() => {
    fetch("{% url 'draft_status' draft.id %}")
      .then(response => response.json())
      .then(data => {
        const currentStatusEl = document.getElementById('current-status');
        currentStatusEl.innerHTML = `ç›®å‰è¼ªæ¬¡ï¼š<strong>${data.current_round}</strong>ï¼Œé †ä½ï¼š<strong>${data.current_pick}</strong>ï¼Œç”± <strong>${data.current_owner}</strong> é¸æ“‡`;
        console.log("Current Status:", currentStatusEl.innerHTML);
        if (data.is_your_turn) {
          document.getElementById('pick-alert').classList.remove('d-none');
        } else {
          document.getElementById('pick-alert').classList.add('d-none');
        }
      });
  }, 10000);
</script>
{% endblock %}